name: CI/CD Pipeline

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Deploy
        run: echo "Deploying..."

      - name: ServiceNow Change (Standard Template)
        id: create
        uses: ServiceNow/servicenow-devops-change@v6.1.0
        with:
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          job-name: "Deploy"

          change-request: >-
            {
              "setCloseCode":"true",
              "autoCloseChange":true,
              "attributes":{
                "type":"standard",
                "std_change_producer":"${{ secrets.SN_STANDARD_CHANGE_TEMPLATE_SYS_ID }}",
                "short_description":"GitHub Deployment - ${{ github.run_number }}",
                "description":"Automated deployment via GitHub Actions"
              }
            }

          interval: "100"
          timeout: "3600"
          changeCreationTimeOut: "3600"

      - name: Debug
        run: |
          echo "CR Number: ${{ steps.create.outputs.change-request-number }}"
          echo "CR Sys ID: ${{ steps.create.outputs.change-request-sys-id }}"
