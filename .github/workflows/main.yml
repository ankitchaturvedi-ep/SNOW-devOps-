name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy to prod
        run: echo "Deploying..."

      # STEP 1: CREATE CHANGE (MINIMAL PAYLOAD)
      - name: ServiceNow Change (Create)
        id: create
        uses: ServiceNow/servicenow-devops-change@v6.1.0
        with:
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          job-name: "Deploy"

          change-request: >-
            {
              "setCloseCode":"true",
              "autoCloseChange":true,
              "attributes":{
                "short_description":"GitHub Deployment - run ${{ github.run_number }}",
                "description":"Automated deployment via GitHub Actions"
              }
            }

          interval: "100"
          timeout: "3600"
          changeCreationTimeOut: "3600"
          abortOnChangeCreationFailure: true
          abortOnChangeStepTimeout: true

      #  DEBUG
      - name: Log created change
        run: |
          echo "CR Number: ${{ steps.create.outputs.change-request-number }}"
          echo "CR Sys ID: ${{ steps.create.outputs.change-request-sys-id }}"

      - name: Fail if change not created
        run: |
          if [ -z "${{ steps.create.outputs.change-request-number }}" ]; then
            echo "Change NOT created"
            exit 1
          fi

      # STEP 2: UPDATE CHANGE 
      - name: ServiceNow Update Change
        uses: ServiceNow/servicenow-devops-update-change@v3.1.0
        with:
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          change-request-number: ${{ steps.create.outputs.change-request-number }}
          change-request-details: >-
            {
              "short_description":"Deployment updated - run ${{ github.run_number }}",
              "description":"Updated via pipeline"
            }

      - name: Done
        run: echo "Pipeline + Change completed"
