# CI/CD Pipeline
# - Runs tests/build on PRs and pushes
# - Runs Deploy + ServiceNow Change ONLY on push to main OR manual run (workflow_dispatch)
# - Creates a change, fails fast if not created, then updates the SAME change (no hardcoded CHG)
# - Start without deployment-gate (most common cause of “blank outputs”); add it back after this works end-to-end.

name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  javascript-test:
    name: JavaScript Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run lint
        run: npm run lint

  deno-test:
    name: Deno Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Run linter
        run: echo "Linting..."

      - name: Run tests
        run: echo "Running tests..."

  build:
    name: Build
    needs: [javascript-test, deno-test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Build repo
        run: echo "Building..."

  deploy:
    name: Deploy
    needs: [build]
    runs-on: ubuntu-latest

    # Prevent ServiceNow calls on PRs (especially fork PRs) where secrets may not be available.
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Deploy to prod
        run: echo "Deploying..."

      - name: Preflight ServiceNow secrets (safe)
        run: |
          test -n "${{ secrets.SN_INSTANCE_URL }}" || (echo "Missing SN_INSTANCE_URL" && exit 1)
          test -n "${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}" || (echo "Missing SN_DEVOPS_INTEGRATION_TOKEN" && exit 1)
          test -n "${{ secrets.SN_ORCHESTRATION_TOOL_ID }}" || (echo "Missing SN_ORCHESTRATION_TOOL_ID" && exit 1)

      - name: ServiceNow Change (Create)
        uses: ServiceNow/servicenow-devops-change@v6.1.0
        id: create
        with:
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          job-name: "Deploy"
          change-request: >-
            {"setCloseCode":"true","autoCloseChange":true,
             "attributes":{
               "short_description":"GitHub Automated Software Deployment",
               "description":"Automated Software Deployment.",
               "assignment_group":"a715cd759f2002002920bde8132e7018",
               "implementation_plan":"Software update is tested and results can be found in Test Summaries Tab; When the change is approved the implementation happens automated by the CICD pipeline within the change planned start and end time window.",
               "backout_plan":"When software fails in production, the previous software release will be re-deployed.",
               "test_plan":"Testing if the software was successfully deployed"
             }}
          interval: "100"
          timeout: "3600"
          changeCreationTimeOut: "3600"
          abortOnChangeCreationFailure: true
          abortOnChangeStepTimeout: true

          # NOTE: Add this back ONLY after you confirm create+update works.
          # deployment-gate: '{"environment":"deploymentgate","jobName":"Deploy"}'

      - name: Log created change
        run: |
          echo "change-request-number=${{ steps.create.outputs.change-request-number }}"
          echo "change-request-sys-id=${{ steps.create.outputs.change-request-sys-id }}"

      - name: Fail if change not created
        run: |
          if [ -z "${{ steps.create.outputs.change-request-number }}" ]; then
            echo "ServiceNow change was NOT created (output empty). Open the 'ServiceNow Change (Create)' step logs to see the reason."
            exit 1
          fi

      - name: ServiceNow Update Change (Update the created CHG)
        uses: ServiceNow/servicenow-devops-update-change@v3.1.0
        with:
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          change-request-number: ${{ steps.create.outputs.change-request-number }}
          change-request-details: >-
            {"short_description":"Hello from CICD Pipeline",
             "description":"Automated Software Deployment (updated by pipeline).",
             "assignment_group":"a715cd759f2002002920bde8132e7018",
             "implementation_plan":"Software update is tested and results can be found in Test Summaries Tab; When the change is approved the implementation happens automated by the CICD pipeline within the change planned start and end time window.",
             "backout_plan":"When software fails in production, the previous software release will be re-deployed.",
             "test_plan":"Testing if the software was successfully deployed"}

      - name: Final summary
        run: |
          echo "DONE: change-request-number=${{ steps.create.outputs.change-request-number }}"
          echo "DONE: change-request-sys-id=${{ steps.create.outputs.change-request-sys-id }}"
