name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  javascript-test:
    name: JavaScript Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run lint
        run: npm run lint

  deno-test:
    name: Deno Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Run linter
        run: echo "Linting..."

      - name: Run tests
        run: echo "Running tests..."

  build:
    name: Build
    needs: [javascript-test, deno-test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Build repo
        run: echo "Building..."

  deploy:
    name: Deploy
    needs: [build]
    runs-on: ubuntu-latest

    # Do NOT call ServiceNow on PRs (especially fork PRs) where secrets may be unavailable.
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Deploy to prod
        run: echo "Deploying..."

      - name: Preflight ServiceNow secrets (safe)
        run: |
          test -n "${{ secrets.SN_INSTANCE_URL }}" || (echo "Missing SN_INSTANCE_URL" && exit 1)
          test -n "${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}" || (echo "Missing SN_DEVOPS_INTEGRATION_TOKEN" && exit 1)
          test -n "${{ secrets.SN_ORCHESTRATION_TOOL_ID }}" || (echo "Missing SN_ORCHESTRATION_TOOL_ID" && exit 1)
          test -n "${{ secrets.SN_CHANGE_MODEL_SYS_ID }}" || (echo "Missing SN_CHANGE_MODEL_SYS_ID" && exit 1)
          test -n "${{ secrets.SN_ASSIGNMENT_GROUP_SYS_ID }}" || (echo "Missing SN_ASSIGNMENT_GROUP_SYS_ID" && exit 1)

      - name: ServiceNow Change (Create)
        uses: ServiceNow/servicenow-devops-change@v6.1.0
        id: create
        with:
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          job-name: "Deploy"

          # Minimal payload aligned to your instance UI (Category DevOps, Priority 4-Low, Risk Low, Impact 3-Low)
          change-request: >-
            {"setCloseCode":"true","autoCloseChange":true,
             "attributes":{
               "chg_model":{"sys_id":"${{ secrets.SN_CHANGE_MODEL_SYS_ID }}"},
               "category":"DevOps",
               "short_description":"GitHub Automated Deployment",
               "description":"Deployment triggered from GitHub Actions pipeline.",
               "assignment_group":"${{ secrets.SN_ASSIGNMENT_GROUP_SYS_ID }}",
               "risk":"3",
               "impact":"3",
               "priority":"4"
             }}

          interval: "100"
          timeout: "3600"
          changeCreationTimeOut: "3600"
          abortOnChangeCreationFailure: true
          abortOnChangeStepTimeout: true

          # Uncomment ONLY if your deployment gate is configured for THIS tool
          # deployment-gate: '{"environment":"deploymentgate","jobName":"Deploy"}'

      - name: Log created change
        run: |
          echo "change-request-number=${{ steps.create.outputs.change-request-number }}"
          echo "change-request-sys-id=${{ steps.create.outputs.change-request-sys-id }}"

      - name: Fail if change not created
        run: |
          if [ -z "${{ steps.create.outputs.change-request-number }}" ]; then
            echo "ServiceNow change was NOT created (output empty). Check the 'ServiceNow Change (Create)' step logs."
            exit 1
          fi

      - name: ServiceNow Update Change (Update created CHG)
        uses: ServiceNow/servicenow-devops-update-change@v3.1.0
        with:
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          change-request-number: ${{ steps.create.outputs.change-request-number }}
          change-request-details: >-
            {"short_description":"Deployment completed (pipeline update)",
             "description":"Deployment step finished; updating change from CI/CD pipeline."}

      - name: Final summary
        run: |
          echo "DONE: change-request-number=${{ steps.create.outputs.change-request-number }}"
          echo "DONE: change-request-sys-id=${{ steps.create.outputs.change-request-sys-id }}"
